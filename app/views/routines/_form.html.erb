<%= form_with(model: routine, local: true, class: "needs-validation", novalidate: true) do |form| %>
  <% if routine.errors.any? %>
    <div class="alert alert-danger" role="alert">
      <h4>Please fix the following errors:</h4>
      <ul class="mb-0">
        <% routine.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-4">
      <div class="mb-3">
        <%= form.label :user_id, "Assign to Student", class: "form-label fw-bold" %>
        
        <% if @pre_selected_student.present? %>
          <!-- Pre-selected student (from student's profile page) -->
          <%= form.hidden_field :user_id %>
          <input type="text" class="form-control" value="<%= @pre_selected_student.full_name %>" readonly>
        <% else %>
          <!-- Normal student selection dropdown -->
          <%= form.select :user_id, 
                options_from_collection_for_select(@students, :id, :full_name, routine.user_id),
                { prompt: "Select a student" },
                { class: "form-select", required: true } %>
          <div class="invalid-feedback">
            Please select a student to assign this routine to.
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="mb-3">
        <%= form.label :dance_category_id, "Dance Category", class: "form-label fw-bold" %>
        <%= form.select :dance_category_id, 
              options_from_collection_for_select(@dance_categories, :id, :name, routine.dance_category_id),
              { prompt: "Select a dance category" },
              { class: "form-select", required: true } %>
        <div class="invalid-feedback">
          Please select a dance category.
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="mb-3">
        <%= form.label :dance_style_id, "Dance Style", class: "form-label fw-bold" %>
        <%= form.select :dance_style_id, 
              options_from_collection_for_select(@dance_styles, :id, :name, routine.dance_style_id),
              { prompt: "Select a dance style" },
              { class: "form-select", required: true } %>
        <div class="invalid-feedback">
          Please select a dance style.
        </div>
      </div>
    </div>
  </div>
  
  <div class="mb-3">
    <%= form.label :description, class: "form-label fw-bold" %>
    
    <!-- Trix Editor for Rich Text -->
    <%= form.rich_text_area :description, 
          placeholder: "Describe the routine steps, movements, and instructions in detail...",
          class: "form-control",
          style: "min-height: 300px;",
          data: { 
            "bs-toggle": "tooltip",
            "bs-placement": "top",
            "bs-title": "Use the toolbar to format your routine description with bold text, lists, and more."
          } %>
    
    <div class="form-text">
      Provide detailed instructions for the routine. Use the toolbar to format text, add lists, and structure your content.
    </div>
  </div>

  <div class="d-flex gap-2">
    <%= form.submit routine.persisted? ? "Update Routine" : "Create Routine", 
          class: "btn btn-primary" %>
    
    <%= link_to routines_path, class: "btn btn-secondary" do %>
      <i class="fas fa-times me-1"></i>Cancel
    <% end %>
  </div>
<% end %>



<style>
/* Custom styles for Quill editor to match Bootstrap */
#quill-editor {
  background-color: #fff;
}

#quill-editor.is-invalid {
  border-color: #dc3545;
}

#quill-editor.is-valid {
  border-color: #198754;
}

.ql-toolbar {
  border-top: 1px solid #dee2e6;
  border-left: 1px solid #dee2e6;
  border-right: 1px solid #dee2e6;
  border-bottom: none;
  border-radius: 0.375rem 0.375rem 0 0;
}

.ql-container {
  border-bottom: 1px solid #dee2e6;
  border-left: 1px solid #dee2e6;
  border-right: 1px solid #dee2e6;
  border-top: none;
  border-radius: 0 0 0.375rem 0.375rem;
  font-family: inherit;
}

.ql-editor {
  min-height: 200px;
  font-size: 1rem;
  line-height: 1.5;
}

.ql-editor.ql-blank::before {
  font-style: italic;
  color: #6c757d;
}
</style>