<% content_for :title, "Book Private Lesson - Select Time Slot" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 text-primary">
          <i class="fas fa-calendar-check me-2"></i>
          Book Private Lesson - Select Time Slot
        </h1>
        <%= link_to private_lessons_path, class: "btn btn-outline-secondary" do %>
          <i class="fas fa-arrow-left me-1"></i>Back to Lessons
        <% end %>
      </div>

      <div class="row">
        <!-- Step 1: Select Instructor and Duration -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-filter me-2"></i>Step 1: Basic Preferences
              </h5>
            </div>
            <div class="card-body">
              <%= form_with url: available_slots_private_lessons_path, method: :get, local: true, class: "needs-validation", id: "instructor_selection_form" do |f| %>
                <% unless current_user.student? %>
                  <div class="mb-3">
                    <%= f.label :student_id, "Student", class: "form-label fw-bold" %>
                    <%= f.select :student_id, 
                          options_from_collection_for_select(@students, :id, :full_name, params[:student_id]),
                          { prompt: "Select a student..." },
                          { class: "form-select", required: true } %>
                    <div class="form-text">Choose which student this lesson is for</div>
                  </div>
                <% else %>
                  <%= f.hidden_field :student_id, value: current_user.id %>
                <% end %>
                
                <div class="mb-3">
                  <%= f.label :instructor_id, "Instructor", class: "form-label fw-bold" %>
                    <%= f.select :instructor_id, 
                          options_from_collection_for_select(@instructors, :id, lambda { |i| "#{i.full_name} ($#{i.hourly_rate || 100}/hr)" }, @instructor_id),
                          { prompt: "Select an instructor..." },
                          { class: "form-select", required: true, onchange: "this.form.submit();" } %>
                </div>

                <div class="mb-3">
                  <%= f.label :duration, "Duration", class: "form-label fw-bold" %>
                  <%= f.select :duration,
                        options_for_select([
                          ['30 minutes', 30],
                          ['45 minutes', 45],
                          ['60 minutes', 60],
                          ['90 minutes', 90],
                          ['120 minutes', 120]
                        ], @duration),
                        {},
                        { class: "form-select", required: true, onchange: "this.form.submit();" } %>
                </div>

                <div class="mb-3">
                  <%= f.label :location_id, "Location", class: "form-label fw-medium" %>
                  <%= f.select :location_id, 
                        options_from_collection_for_select(@locations, :id, :name, @location_id),
                        { prompt: "Select location..." },
                        { class: "form-select", required: true } %>
                </div>

                <% unless @instructor_id %>
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search me-1"></i>Find Available Dates
                  </button>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Step 2: Select Available Date -->
        <div class="col-lg-4">
          <% if @instructor_id && @available_dates %>
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                  <i class="fas fa-calendar me-2"></i>Step 2: Choose Date
                </h5>
              </div>
              <div class="card-body">
                <% if @available_dates.any? %>
                  <div class="mb-3">
                    <p class="mb-3">
                      <strong><%= @instructor.full_name %></strong> has availability on these dates:
                    </p>
                  </div>

                  <div class="available-dates-grid">
                    <% @available_dates.each do |date| %>
                      <%= form_with url: available_slots_private_lessons_path, method: :get, local: true, class: "date-selection-form" do |f| %>
                        <%= f.hidden_field :student_id, value: current_user.student? ? current_user.id : @student_id %>
                        <%= f.hidden_field :instructor_id, value: @instructor.id %>
                        <%= f.hidden_field :duration, value: @duration %>
                        <%= f.hidden_field :location_id, value: @location_id %>
                        <%= f.hidden_field :date, value: date.strftime("%Y-%m-%d") %>
                        
                        <button type="submit" class="btn <%= @date == date ? 'btn-primary' : 'btn-outline-primary' %> w-100 mb-2 date-btn">
                          <div class="fw-bold"><%= date.strftime("%a") %></div>
                          <div><%= date.strftime("%b %d") %></div>
                          <div class="small"><%= date.year %></div>
                        </button>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-center py-4">
                    <i class="fas fa-calendar-times text-muted fs-1 mb-3"></i>
                    <h6 class="text-muted">No Available Dates</h6>
                    <p class="text-muted small">
                      <%= @instructor.full_name %> doesn't have any <%= @duration %>-minute availability in the next 30 days.
                    </p>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="card">
              <div class="card-body text-center py-5">
                <i class="fas fa-arrow-left text-muted fs-1 mb-3"></i>
                <h6 class="text-muted">Select Instructor First</h6>
                <p class="text-muted small">
                  Choose an instructor and duration to see available dates.
                </p>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Step 3: Select Time Slot -->
        <div class="col-lg-4">
          <% if @instructor_id && @date && @available_slots %>
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                  <i class="fas fa-clock me-2"></i>Step 3: Choose Time
                </h5>
              </div>
              <div class="card-body">
                <!-- Debug Info (remove in production) -->
                <% if Rails.env.development? %>
                  <div class="alert alert-info small mb-3">
                    <strong>Debug Info:</strong><br>
                    Student ID: <%= current_user.student? ? current_user.id : params[:student_id] %><br>
                    Instructor ID: <%= @instructor.id if @instructor %><br>
                    Location ID: <%= @location_id %><br>
                    Duration: <%= @duration %><br>
                    Date: <%= @date %><br>
                    Cost: $<%= sprintf('%.2f', (@instructor.hourly_rate || 100) * (@duration.to_f / 60.0)) if @instructor && @duration %>
                  </div>
                <% end %>
                
                <div class="mb-3">
                  <div class="text-center mb-3">
                    <h6 class="mb-1">
                      <%= @date.strftime("%A, %B %d, %Y") %>
                    </h6>
                    <small class="text-muted">
                      <%= pluralize(@duration, 'minute') %> lesson â€¢ 
                      $<%= sprintf('%.2f', (@instructor.hourly_rate || 100) * (@duration / 60.0)) %>
                    </small>
                  </div>
                  <hr>
                </div>

                <% if @available_slots.any? %>
                  <div class="time-slots-grid">
                    <% @available_slots.each do |slot| %>
                      <%= form_with model: PrivateLesson.new, local: true, class: "slot-booking-form" do |f| %>
                        <%= f.hidden_field :student_id, value: current_user.student? ? current_user.id : params[:student_id] %>
                        <%= f.hidden_field :instructor_id, value: @instructor.id %>
                        <%= f.hidden_field :location_id, value: @location_id %>
                        <%= f.hidden_field :scheduled_at, value: slot[:start_time].iso8601 %>
                        <%= f.hidden_field :duration, value: @duration %>
                        <%= f.hidden_field :status, value: current_user.student? ? 'requested' : 'scheduled' %>
                        <%= f.hidden_field :cost, value: (@instructor.hourly_rate || 100) * (@duration.to_f / 60.0) %>
                        
                        <button type="submit" class="btn btn-outline-success w-100 mb-2 time-slot-btn"
                                data-confirm="Book this <%= @duration %>-minute lesson with <%= @instructor.full_name %> on <%= @date.strftime('%A, %B %d') %> at <%= slot[:formatted_time] %>?">
                          <div class="fw-bold"><%= slot[:formatted_time] %></div>
                          <div class="small">to <%= slot[:formatted_end] %></div>
                          <div class="small text-success">
                            $<%= sprintf('%.2f', (@instructor.hourly_rate || 100) * (@duration.to_f / 60.0)) %>
                          </div>
                        </button>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fs-3 mb-3"></i>
                    <h6 class="text-muted">No Slots Available</h6>
                    <p class="text-muted small">
                      All slots are booked for this date. Please try another date.
                    </p>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="card">
              <div class="card-body text-center py-5">
                <i class="fas fa-arrow-left text-muted fs-1 mb-3"></i>
                <h6 class="text-muted">Select Date First</h6>
                <p class="text-muted small">
                  Choose a date to see available time slots.
                </p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.time-slot-card {
  transition: all 0.2s ease;
  cursor: pointer;
}

.time-slot-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.date-btn {
  transition: all 0.2s ease;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.date-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-slot-btn {
  transition: all 0.2s ease;
  min-height: 60px;
}

.time-slot-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.available-dates-grid {
  max-height: 400px;
  overflow-y: auto;
}

.time-slots-grid {
  max-height: 400px;
  overflow-y: auto;
}

.bg-gold {
  background-color: #ffd700;
}
</style>

<script>
// Auto-submit form when selections change
document.addEventListener('DOMContentLoaded', function() {
  const instructorForm = document.getElementById('instructor_selection_form');
  
  // Auto-submit when instructor or duration changes
  if (instructorForm) {
    const selects = instructorForm.querySelectorAll('select');
    selects.forEach(select => {
      select.addEventListener('change', function() {
        // Only submit if instructor is selected
        const instructorSelect = instructorForm.querySelector('[name="instructor_id"]');
        if (instructorSelect && instructorSelect.value) {
          instructorForm.submit();
        }
      });
    });
  }
  
  // Add hover effects to buttons
  const dateButtons = document.querySelectorAll('.date-btn');
  const timeButtons = document.querySelectorAll('.time-slot-btn');
  
  [...dateButtons, ...timeButtons].forEach(button => {
    button.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
    });
    
    button.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
});
</script>
