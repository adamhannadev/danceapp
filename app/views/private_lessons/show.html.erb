<% content_for :title, "Private Lesson Details" %>

<style>
  .btn-group .dropdown-menu .dropdown-item {
    padding: 0.5rem 0;
  }
  .btn-group .dropdown-menu .dropdown-item form {
    width: 100%;
  }
  .btn-group .dropdown-menu .dropdown-item button {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 0.5rem 1rem;
  }
  .btn-group .dropdown-menu .dropdown-item button:hover {
    background-color: var(--bs-gray-100);
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 text-primary">
          <i class="fas fa-user-graduate me-2"></i>Private Lesson Details
        </h1>
        <div>
          <%= link_to private_lessons_path, class: "btn btn-outline-secondary me-2" do %>
            <i class="fas fa-arrow-left me-1"></i>Back to Lessons
          <% end %>
          
          <% if current_user.admin? || current_user == @private_lesson.instructor || (current_user == @private_lesson.student && @private_lesson.status == 'requested') %>
            <%= link_to edit_private_lesson_path(@private_lesson), class: "btn btn-warning me-2" do %>
              <i class="fas fa-edit me-1"></i>Edit
            <% end %>
          <% end %>
          
          <% if @private_lesson.can_be_confirmed? && (current_user.instructor? || current_user.admin?) %>
            <%= link_to confirm_private_lesson_path(@private_lesson),
                  class: "btn btn-success me-2",
                  data: { turbo_method: :patch, turbo_confirm: "Confirm this lesson?" } do %>
              <i class="fas fa-check me-1"></i>Confirm Lesson
            <% end %>
          <% end %>
          
          <% if @private_lesson.can_be_cancelled? && (current_user.instructor? || current_user.admin?) %>
            <%= link_to cancel_private_lesson_path(@private_lesson),
                  class: "btn btn-danger",
                  data: { turbo_method: :patch, turbo_confirm: "Cancel this lesson? This action cannot be undone." } do %>
              <i class="fas fa-times me-1"></i>Cancel Lesson
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="row">
        <!-- Main Lesson Information -->
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>Lesson Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Date & Time</label>
                    <div class="fs-5">
                      <%= @private_lesson.scheduled_at.strftime("%A, %B %d, %Y") %>
                    </div>
                    <div class="text-muted">
                      <%= @private_lesson.scheduled_at.strftime("%I:%M %p") %> - 
                      <%= @private_lesson.end_time.strftime("%I:%M %p") %>
                      (<%= @private_lesson.formatted_duration %>)
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Location</label>
                    <div class="fs-5"><%= @private_lesson.location.name %></div>
                    <% if @private_lesson.location.address.present? %>
                      <div class="text-muted"><%= @private_lesson.location.address %></div>
                    <% end %>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Student</label>
                    <div class="d-flex align-items-center">
                      <div class="avatar-circle bg-light-purple text-white me-2">
                            <%= @private_lesson.student.first_name.first.upcase %>
                      </div>
                        <div class="fs-5"><%= link_to @private_lesson.student.full_name, user_path(@private_lesson.student) %></div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Instructor</label>
                    <div class="d-flex align-items-center">
                      <div class="avatar-circle bg-gold text-white me-2">
                            <%= @private_lesson.instructor.first_name.first.upcase %>
                      </div>
                        <div class="fs-5"><%= link_to @private_lesson.instructor.full_name,  user_path(@private_lesson.instructor.id) %></div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Status</label>
                    <div>
                      <span class="badge bg-<%= @private_lesson.status_color %> fs-6">
                        <%= @private_lesson.status_text %>
                      </span>
                    </div>
                    <% if @private_lesson.confirmed_at.present? %>
                      <small class="text-muted">
                        Confirmed on <%= @private_lesson.confirmed_at.strftime("%B %d, %Y at %I:%M %p") %>
                      </small>
                    <% end %>
                    <% if @private_lesson.cancelled_at.present? %>
                      <small class="text-muted">
                        Cancelled on <%= @private_lesson.cancelled_at.strftime("%B %d, %Y at %I:%M %p") %>
                      </small>
                    <% end %>
                  </div>
                </div>
              </div>

              <% if @private_lesson.notes.present? %>
                <div class="mb-3">
                  <label class="form-label fw-bold text-muted">Notes</label>
                  <div class="border rounded p-3 bg-light">
                    <%= simple_format(@private_lesson.notes) %>
                  </div>
                </div>
              <% end %>

              <% if @private_lesson.is_recurring? %>
                <div class="mb-3">
                  <label class="form-label fw-bold text-muted">
                    <i class="fas fa-repeat me-1"></i>Recurring Lesson Information
                  </label>
                  <div class="border rounded p-3 bg-info bg-opacity-10">
                    <div class="row">
                      <div class="col-md-6">
                        <strong>Lesson Type:</strong> 
                        <span class="badge bg-info">
                          <%= @private_lesson.is_parent_lesson? ? 'Parent Lesson (Original)' : 'Part of Series' %>
                        </span>
                      </div>
                      <% if @private_lesson.recurrence_rule.present? %>
                        <div class="col-md-6">
                          <strong>Frequency:</strong> <%= @private_lesson.recurrence_rule.humanize %>
                        </div>
                      <% end %>
                      <% if @private_lesson.recurring_until.present? %>
                        <div class="col-md-6 mt-2">
                          <strong>Series ends:</strong> <%= @private_lesson.recurring_until.strftime("%B %d, %Y") %>
                        </div>
                      <% end %>
                      <% if @private_lesson.parent_lesson.present? %>
                        <div class="col-md-6 mt-2">
                          <strong>Original lesson:</strong> 
                          <%= link_to @private_lesson.parent_lesson.scheduled_at.strftime("%B %d, %Y"), 
                                @private_lesson.parent_lesson, 
                                class: "text-decoration-none" %>
                        </div>
                      <% end %>
                      <% if @private_lesson.is_parent_lesson? && @private_lesson.recurring_lessons.any? %>
                        <div class="col-12 mt-3">
                          <strong>Remaining lessons in series:</strong> 
                          <span class="badge bg-secondary"><%= @private_lesson.future_recurring_lessons.count %></span>
                          <br>
                          <small class="text-muted">
                            Next: <%= @private_lesson.future_recurring_lessons.first&.scheduled_at&.strftime("%B %d, %Y") || 'None scheduled' %>
                          </small>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Previous Lesson Notes -->
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-arrow-left me-2"></i>Previous Lesson Notes
              </h5>
            </div>
            <div class="card-body">
              <div class="row text-center mb-3">
                <div class="col-12">
                  <% if @previous_lessons.count > 0 %>
                    <% @previous_lessons.each do |l| %>
                      <div class="card mb-2">
                        <div class="card-header">
                          <div class="card-title"> <%= link_to l.scheduled_at.strftime("%B %d, %Y - %I:%M %p"), l %></div>
                        </div>
                        <div class="card-body">
                        <%= l.notes %>
                        </div>
                      </div>  
                    <% end %>
                  <% else %>
                    No previous lessons.
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          <!-- Quick Actions -->
          <!-- <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-bolt me-2"></i>Quick Actions
              </h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <% if current_user.admin? || current_user == @private_lesson.instructor %>
                  <%= link_to "#", class: "btn btn-outline-primary" do %>
                    <i class="fas fa-envelope me-1"></i>Send Reminder
                  <% end %>
                  
                  <%= link_to "#", class: "btn btn-outline-info" do %>
                    <i class="fas fa-calendar-plus me-1"></i>Schedule Follow-up
                  <% end %>
                <% end %>
                
                <% if current_user.admin? %>
                  <% if @private_lesson.is_recurring? %>
                    <!-- Recurring lesson delete with options -->
                    <div class="btn-group dropstart">
                      <button type="button" class="btn btn-outline-danger dropdown-toggle" 
                              data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-trash me-1"></i>Delete Options
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <h6 class="dropdown-header">
                            <i class="fas fa-repeat me-1"></i>Recurring Lesson Options
                          </h6>
                        </li>
                        <li>
                          <%= button_to @private_lesson, 
                                method: :delete, 
                                params: { delete_future: false },
                                class: "dropdown-item text-warning",
                                data: { 
                                  confirm: "Delete only this lesson? Previous and future lessons in the series will remain unchanged." 
                                },
                                form: { class: "d-inline w-100" } do %>
                            <i class="fas fa-minus-circle me-2"></i>Delete this lesson only
                          <% end %>
                        </li>
                        <li>
                          <%= button_to @private_lesson, 
                                method: :delete, 
                                params: { delete_future: true },
                                class: "dropdown-item text-danger",
                                data: { 
                                  confirm: "Delete this lesson and all future lessons in the series? Lessons before this one will remain. This cannot be undone." 
                                },
                                form: { class: "d-inline w-100" } do %>
                            <i class="fas fa-trash me-2"></i>Delete this and all following
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  <% else %>
                    <!-- Regular single lesson delete -->
                    <%= link_to @private_lesson,  
                          class: "btn btn-outline-danger",
                          data: { 
                              turbo_method: :delete,
                            turbo_confirm: "Are you sure? This will permanently delete this lesson and cannot be undone." 
                          } do %>
                      <i class="fas fa-trash me-1"></i>Delete Lesson
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </div>
</div>
