<% content_for :title, @private_lesson.new_record? ? "Book New Private Lesson" : "Edit Private Lesson" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 text-primary">
          <i class="fas fa-user-graduate me-2"></i>
          <%= @private_lesson.new_record? ? "Book New Private Lesson" : "Edit Private Lesson" %>
        </h1>
        <%= link_to private_lessons_path, class: "btn btn-outline-secondary" do %>
          <i class="fas fa-arrow-left me-1"></i>Back to Lessons
        <% end %>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-calendar-plus me-2"></i>Lesson Details
              </h5>
            </div>
            <div class="card-body">
              <%= form_with model: @private_lesson, local: true, class: "needs-validation", novalidate: true do |f| %>
                <% if @private_lesson.errors.any? %>
                  <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Please fix the following errors:</h6>
                    <ul class="mb-0">
                      <% @private_lesson.errors.full_messages.each do |message| %>
                        <li><%= message %></li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <%= f.label :student_id, class: "form-label fw-bold" %>
                      <% if current_user.student? %>
                        <%= f.hidden_field :student_id, value: current_user.id %>
                        <div class="form-control-plaintext">
                          <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-light-purple text-white me-2">
                              <%= current_user.first_name.first.upcase %>
                            </div>
                            <div>
                              <div class="fw-bold"><%= current_user.full_name %></div>
                              <small class="text-muted"><%= current_user.email %></small>
                            </div>
                          </div>
                        </div>
                      <% else %>
                        <%= f.select :student_id, 
                              options_from_collection_for_select(@students, :id, :full_name, @private_lesson.student_id),
                              { prompt: "Select a student..." },
                              { class: "form-select", required: true } %>
                      <% end %>
                    </div>

                    <div class="mb-3">
                      <%= f.label :instructor_id, class: "form-label fw-bold" %>
                        <%= f.select :instructor_id, 
                              options_from_collection_for_select(@instructors, :id, :full_name, @private_lesson.instructor_id),
                              { prompt: "Select an instructor..." },
                              { class: "form-select", required: true, id: "instructor_select" } %>
                    </div>

                    <!-- Removed dance_style and dance_level fields -->

                    <div class="mb-3">
                      <%= f.label :location_id, class: "form-label fw-bold" %>
                      <%= f.select :location_id, 
                            options_from_collection_for_select(@locations, :id, :name, @private_lesson.location_id),
                            { prompt: "Select location..." },
                            { class: "form-select", required: true } %>
                    </div>
                    <div class="mb-3">
                      <%= f.label :scheduled_at, "Date & Time", class: "form-label fw-bold" %>
                      <%= f.datetime_local_field :scheduled_at, 
                            class: "form-control", 
                            required: true %>
                      <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Lessons must be scheduled at least 24 hours in advance
                      </div>
                    </div>

                    <div class="mb-3">
                      <%= f.label :duration, "Duration (minutes)", class: "form-label fw-bold" %>
                      <%= f.select :duration,
                            options_for_select([
                              ['30 minutes', 30],
                              ['45 minutes', 45],
                              ['60 minutes', 60],
                              ['90 minutes', 90],
                              ['120 minutes', 120]
                            ], @private_lesson.duration),
                            { prompt: "Select duration..." },
                            { class: "form-select", required: true, id: "duration_select" } %>
                    </div>

                    <% if current_user.admin? || current_user.instructor? %>
                      <div class="mb-3">
                        <%= f.label :status, class: "form-label fw-bold" %>
                        <%= f.select :status,
                              options_for_select([
                                ['Requested', 'requested'],
                                ['Scheduled', 'scheduled'],
                                ['Completed', 'completed'],
                                ['Cancelled', 'cancelled']
                              ], @private_lesson.status),
                              {},
                              { class: "form-select" } %>
                      </div>

                      <!-- Cost field removed; now calculated in controller -->
                    <% end %>
                  </div>

                  <div class="col-md-6">
                    <div class="col-md-12 mb-3">
                      <%= f.label :notes, class: "form-label fw-bold" %>
                      <%= f.text_area :notes, 
                            class: "form-control", 
                            rows: 6,
                            placeholder: "Lesson plan or any other notes..." %>
                    </div>
                  </div>
                </div>
                
                <!-- Recurring Lesson Options (Only for Instructors and Admins) -->
                <% if current_user.instructor? || current_user.admin? %>
                  <div class="row">
                    <div class="col-12">
                      <hr class="my-4">
                      <h6 class="text-primary mb-3">
                        <i class="fas fa-repeat me-2"></i>Recurring Lesson Options
                      </h6>
                      
                      <div class="mb-3">
                        <div class="form-check form-switch">
                          <%= f.check_box :is_recurring, 
                                class: "form-check-input" %>
                          <%= f.label :is_recurring, "Make this a recurring lesson", class: "form-check-label fw-bold" %>
                        </div>
                        <small class="text-muted">
                          Check this to automatically create multiple lessons with the same details
                        </small>
                      </div>
                        
                        <div class="collapse <%= 'show' if @private_lesson.is_recurring? %>" id="recurring_options">
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <%= f.label :recurrence_rule, "Frequency", class: "form-label" %>
                              <%= f.select :recurrence_rule,
                                    options_for_select([
                                      ['Weekly (every 7 days)', 'weekly'],
                                      ['Bi-weekly (every 14 days)', 'biweekly'],
                                      ['Monthly (every 30 days)', 'monthly']
                                    ], @private_lesson.recurrence_rule),
                                    { prompt: "Select frequency..." },
                                    { class: "form-select" } %>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                              <%= f.label :recurring_until, "Repeat until", class: "form-label" %>
                              <%= f.date_field :recurring_until,
                                    value: @private_lesson.recurring_until || Date.current.end_of_year,
                                    min: Date.current + 1.week,
                                    max: Date.current.end_of_year,
                                    class: "form-control" %>
                              <small class="text-muted">Maximum: end of current year</small>
                            </div>
                          </div>
                          
                          <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Recurring lessons will be created automatically based on your schedule.
                            Each lesson will have the same instructor, duration, and location.
                          </div>
                        </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
            
            <div class="row mt-2 mb-2">
                <div class="d-flex gap-2">
                  <%= f.submit (@private_lesson.new_record? ? "Book Lesson" : "Update Lesson"), class: "btn btn-primary" %>
                  
                  <%= link_to private_lessons_path, class: "btn btn-secondary" do %>
                    <i class="fas fa-times me-1"></i>Cancel
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
      </div>

        <!-- Sidebar with helpful information -->
        <!-- <div class="col-lg-4">
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-lightbulb me-2"></i>Booking Guidelines
              </h5>
            </div>
            <div class="card-body">
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="fas fa-clock text-warning me-2"></i>
                  <strong>24-Hour Notice:</strong> Lessons must be booked at least 24 hours in advance
                </li>
                <li class="mb-2">
                  <i class="fas fa-calendar-times text-danger me-2"></i>
                  <strong>Cancellation:</strong> Free cancellation up to 24 hours before the lesson
                </li>
                <li class="mb-2">
                  <i class="fas fa-percentage text-success me-2"></i>
                  <strong>Member Discount:</strong> Monthly/Annual members receive automatic 5% discount
                </li>
                <li class="mb-2">
                  <i class="fas fa-credit-card text-primary me-2"></i>
                  <strong>Payment:</strong> Payment is due before or at the time of the lesson
                </li>
              </ul>
            </div>
          </div> -->

          <% if current_user.admin? %>
          <div class="card" id="cost_breakdown" style="display: block;">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-calculator me-2"></i>Cost Breakdown
              </h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-12 mb-3">
                  <div class="fs-2 fw-bold text-primary" id="total_cost">$0.00</div>
                  <small class="text-muted">Total Cost</small>
                </div>
              </div>
              
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                  <span>Base Rate:</span>
                  <span id="base_rate">$0.00/hr</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Duration:</span>
                  <span id="duration_display">0 minutes</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Subtotal:</span>
                  <span id="subtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between text-success" id="discount_row" style="display: none;">
                  <span>Membership Discount:</span>
                  <span id="discount_amount">-$0.00</span>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const instructorSelect = document.getElementById('instructor_select');
  const durationSelect = document.getElementById('duration_select');
  const costField = document.getElementById('cost_field');
  const costBreakdown = document.getElementById('cost_breakdown');
  
  // Calculate cost when instructor or duration changes
  function calculateCost() {
    const instructorOption = instructorSelect?.options[instructorSelect.selectedIndex];
    const duration = durationSelect?.value;
    
    if (instructorOption && duration && instructorOption.value) {
      // Extract hourly rate from option text (format: "Name ($100/hr)")
      const rateMatch = instructorOption.text.match(/\$(\d+(?:\.\d+)?)/);
      const hourlyRate = rateMatch ? parseFloat(rateMatch[1]) : 0;
      
      if (hourlyRate > 0) {
        const durationHours = duration / 60;
        const subtotal = hourlyRate * durationHours;
        
        // Apply membership discount if applicable (you'd need to pass this from the server)
        // For now, we'll assume no discount in the calculation
        const total = subtotal;
        
        // Update form field
        if (costField) {
          costField.value = total.toFixed(2);
        }
        
        // Update cost breakdown
        updateCostBreakdown(hourlyRate, duration, subtotal, total);
      }
    }
  }
  
  function updateCostBreakdown(hourlyRate, duration, subtotal, total) {
    document.getElementById('base_rate').textContent = `$${hourlyRate.toFixed(2)}/hr`;
    document.getElementById('duration_display').textContent = `${duration} minutes`;
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('total_cost').textContent = `$${total.toFixed(2)}`;
    
    costBreakdown.style.display = 'block';
  }
  
  // Attach event listeners
  instructorSelect?.addEventListener('change', calculateCost);
  durationSelect?.addEventListener('change', calculateCost);
  
  // Calculate on page load if values are already selected
  if (instructorSelect?.value && durationSelect?.value) {
    calculateCost();
  }
  
  // Handle recurring lesson toggle
  setTimeout(function() {
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
      console.warn('Bootstrap not available for recurring toggle');
    }
    
    const recurringCheckbox = document.querySelector('input[name="private_lesson[is_recurring]"][type="checkbox"]');
    const recurringOptions = document.getElementById('recurring_options');
    
    console.log('Recurring toggle initialization...');
    console.log('Recurring checkbox found:', recurringCheckbox);
    console.log('Recurring options div found:', recurringOptions);
    
    if (recurringCheckbox && recurringOptions) {
      recurringCheckbox.addEventListener('change', function() {
        console.log('Checkbox changed, checked:', this.checked);
        if (this.checked) {
          recurringOptions.classList.add('show');
          console.log('Added show class');
        } else {
          recurringOptions.classList.remove('show');
          console.log('Removed show class');
        }
      });
      
      // Set initial state based on checkbox value
      if (recurringCheckbox.checked) {
        recurringOptions.classList.add('show');
        console.log('Initial state: checkbox is checked, adding show class');
      } else {
        recurringOptions.classList.remove('show');
        console.log('Initial state: checkbox is unchecked, removing show class');
      }
    } else {
      console.error('Could not find recurring checkbox or options div');
      console.log('All checkboxes:', document.querySelectorAll('input[type="checkbox"]'));
      console.log('All divs with id:', document.querySelectorAll('div[id]'));
    }
  }, 100);
});
</script>
