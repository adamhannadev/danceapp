<% content_for :title, "Edit #{@user.full_name}" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Dashboard", dashboard_path %></li>
          <li class="breadcrumb-item"><%= link_to "Users", admin_users_path %></li>
          <li class="breadcrumb-item"><%= link_to @user.full_name, admin_user_path(@user) %></li>
          <li class="breadcrumb-item active" aria-current="page">Edit</li>
        </ol>
      </nav>
      
      <div class="text-center">
        <div class="d-flex justify-content-center align-items-center mb-3">
          <div class="bg-<%= user_role_color(@user.role) %> rounded-circle d-flex align-items-center justify-content-center me-3" 
               style="width: 60px; height: 60px;">
            <i class="fas fa-<%= user_role_icon(@user.role) %> text-white fs-4"></i>
          </div>
          <div>
            <h1 class="h3 mb-1">Edit Profile</h1>
            <p class="text-muted mb-0"><%= @user.full_name %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card card-ballroom">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>Update User Information
          </h5>
        </div>
        <div class="card-body">
          <%= form_with model: @user, local: true, class: "needs-validation", novalidate: true do |form| %>
            
            <!-- Error Messages -->
            <% if @user.errors.any? %>
              <div class="alert alert-danger mb-4">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
                <ul class="mb-0">
                  <% @user.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <!-- Personal Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-user me-2"></i>Personal Information
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :first_name, "First Name *", class: "form-label fw-medium" %>
                <%= form.text_field :first_name, 
                    class: "form-control #{'is-invalid' if @user.errors[:first_name].any?}",
                    required: true %>
                <% if @user.errors[:first_name].any? %>
                  <div class="invalid-feedback">
                    <%= @user.errors[:first_name].first %>
                  </div>
                <% end %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :last_name, "Last Name *", class: "form-label fw-medium" %>
                <%= form.text_field :last_name, 
                    class: "form-control #{'is-invalid' if @user.errors[:last_name].any?}",
                    required: true %>
                <% if @user.errors[:last_name].any? %>
                  <div class="invalid-feedback">
                    <%= @user.errors[:last_name].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-envelope me-2"></i>Contact Information
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :email, "Email Address *", class: "form-label fw-medium" %>
                <%= form.email_field :email, 
                    class: "form-control #{'is-invalid' if @user.errors[:email].any?}",
                    required: true %>
                <% if @user.errors[:email].any? %>
                  <div class="invalid-feedback">
                    <%= @user.errors[:email].first %>
                  </div>
                <% end %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :phone, "Phone Number", class: "form-label fw-medium" %>
                <%= form.telephone_field :phone, 
                    class: "form-control",
                    placeholder: "(555) 123-4567" %>
                <div class="form-text">For class reminders and notifications</div>
              </div>
            </div>

            <!-- Role and Permissions -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-user-tag me-2"></i>Role and Permissions
                </h6>
              </div>
                
              <div class="col-md-6 mb-3">
                <% if current_user.admin? %>
                <%= form.label :role, "User Role *", class: "form-label fw-medium" %>
                <%= form.select :role, 
                    options_for_select([
                      ['Student', 'student'],
                      ['Instructor', 'instructor'],
                      ['Administrator', 'admin']
                    ], @user.role),
                    {},
                    { class: "form-select #{'is-invalid' if @user.errors[:role].any?}", required: true } %>
                <% if @user.errors[:role].any? %>
                  <div class="invalid-feedback">
                    <%= @user.errors[:role].first %>
                  </div>
                <% end %>
                <div class="form-text">Changing role may affect access permissions</div>
                  <% end %>
                  <div class="form-text"><%= @user.role.camelcase %></div>
              </div>
            </div>

            <!-- Membership Information -->
            <!-- <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-crown me-2"></i>Membership Information
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :membership_type, "Membership Type", class: "form-label fw-medium" %>
                <%= form.select :membership_type, 
                    options_for_select([
                      ['No Membership', 'none'],
                      ['Monthly Membership', 'monthly'],
                      ['Annual Membership', 'annual']
                    ], @user.membership_type),
                    {},
                    { class: "form-select" } %>
                <div class="form-text">Members receive discounts on classes and events</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :membership_discount, "Membership Discount (%)", class: "form-label fw-medium" %>
                <%= form.number_field :membership_discount, 
                    class: "form-control",
                    min: 0, max: 100, step: 0.1 %>
                <div class="form-text">Percentage discount applied to class prices</div>
              </div>
            </div> -->

            <!-- Waiver Status -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-file-signature me-2"></i>Legal Requirements
                </h6>
              </div>
              
              <div class="col-12 mb-3">
                <% if @user.waiver_signed? %>
                  <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Waiver Signed</strong>
                        <div class="small">
                          Signed on <%= @user.waiver_signed_at.strftime("%B %d, %Y at %I:%M %p") %>
                        </div>
                      </div>
                      <button type="button" 
                              class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal" 
                              data-bs-target="#waiverModal">
                        <i class="fas fa-eye me-1"></i>View Waiver
                      </button>
                    </div>
                  </div>
                  
                  <% if current_user.admin? || current_user.instructor? %>
                    <div class="form-check">
                      <%= form.check_box :waiver_signed, class: "form-check-input" %>
                      <%= form.label :waiver_signed, "Waiver has been signed", class: "form-check-label" %>
                    </div>
                    <div class="form-text">
                      <i class="fas fa-info-circle me-1"></i>
                      Admins and instructors can manually override waiver status
                    </div>
                  <% end %>
                <% else %>
                  <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Waiver Not Signed</strong>
                        <div class="small">Liability waiver must be signed before participating in classes</div>
                      </div>
                      <button type="button" 
                              class="btn btn-sm btn-primary"
                              data-bs-toggle="modal" 
                              data-bs-target="#waiverModal">
                        <i class="fas fa-file-signature me-1"></i>Sign Waiver
                      </button>
                    </div>
                  </div>
                  
                  <% if current_user.admin? || current_user.instructor? %>
                    <div class="form-check mt-2">
                      <%= form.check_box :waiver_signed, class: "form-check-input" %>
                      <%= form.label :waiver_signed, "Mark waiver as signed", class: "form-check-label" %>
                    </div>
                    <div class="form-text">
                      <i class="fas fa-info-circle me-1"></i>
                      Admins and instructors can manually mark waiver as signed
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>

            <!-- Goals -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-target me-2"></i>Dance Goals
                </h6>
              </div>
              
              <div class="col-12 mb-3">
                <%= form.label :goals, "Personal Dance Goals", class: "form-label fw-medium" %>
                <%= form.rich_text_area :goals, 
                    placeholder: "Share your dance goals, aspirations, or what you hope to achieve..." %>
                <div class="form-text">Optional - helps instructors personalize your learning experience</div>
              </div>
            </div>

            <!-- Current Status Display -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-info-circle me-2"></i>Current Status
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-muted">Member Since:</span>
                      <span class="fw-medium"><%= @user.created_at.strftime("%B %d, %Y") %></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-muted">Last Updated:</span>
                      <span class="fw-medium"><%= @user.updated_at.strftime("%B %d, %Y") %></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <div>
                    <%= link_to "Cancel", admin_user_path(@user), class: "btn btn-outline-secondary" %>
                    <%= link_to "View Profile", admin_user_path(@user), class: "btn btn-outline-info ms-2" %>
                  </div>
                  
                  <div>
                    <%= form.submit "Update Profile", 
                        class: "btn btn-primary",
                        data: { disable_with: "Updating Profile..." } %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card card-ballroom border-danger mt-4 mb-4">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger mb-1">Delete User Account</h6>
              <p class="text-muted small mb-0">
                This action cannot be undone. All user data, progress, and bookings will be permanently deleted.
              </p>
            </div>
            <div>
              <%= link_to admin_user_path(@user), 
                  class: "btn btn-outline-danger",
                  data: { 
                    "turbo-method": :delete,
                    confirm: "Are you sure you want to delete #{@user.full_name}'s account? This action cannot be undone."
                  } do %>
                <i class="fas fa-trash me-1"></i>Delete Account
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Waiver Modal -->
<%= render 'shared/waiver_modal' %>

<script>
// Form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();

// Waiver modal handling for existing users
document.addEventListener('DOMContentLoaded', function() {
  const waiverModal = document.getElementById('waiverModal');
  
  if (waiverModal) {
    waiverModal.setAttribute('data-waiver-modal-user-id-value', '<%= @user.id %>');
    waiverModal.setAttribute('data-waiver-modal-required-value', 'false');
    waiverModal.setAttribute('data-waiver-modal-mode-value', 'profile_update');
  }
});
</script>

<style>
.card-ballroom {
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-label.fw-medium {
  font-weight: 500;
}

.border-bottom {
  border-color: #e9ecef !important;
}

.was-validated .form-control:valid {
  border-color: #198754;
}

.was-validated .form-control:invalid {
  border-color: #dc3545;
}
</style>
