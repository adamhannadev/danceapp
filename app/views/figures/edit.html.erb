<% content_for :title, "Edit #{@figure.name}" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Dashboard", dashboard_path %></li>
          <li class="breadcrumb-item"><%= link_to "Figures", figures_path %></li>
          <li class="breadcrumb-item"><%= link_to @figure.name, figure_path(@figure) %></li>
          <li class="breadcrumb-item active" aria-current="page">Edit</li>
        </ol>
      </nav>
      
      <div class="text-center">
        <div class="d-flex justify-content-center align-items-center mb-3">
          <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" 
               style="width: 60px; height: 60px;">
            <i class="fas fa-edit text-white fs-4"></i>
          </div>
          <div>
            <h1 class="h3 mb-1">Edit Figure</h1>
            <p class="text-muted mb-0"><%= @figure.name %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card card-ballroom">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>Update Figure Information
          </h5>
        </div>
        <div class="card-body">
          <%= form_with model: @figure, local: true, class: "needs-validation", novalidate: true do |form| %>
            
            <!-- Error Messages -->
            <% if @figure.errors.any? %>
              <div class="alert alert-danger mb-4">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
                <ul class="mb-0">
                  <% @figure.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <!-- Basic Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-info-circle me-2"></i>Basic Information
                </h6>
              </div>
              
              <div class="col-md-4 mb-3">
                <%= form.label :figure_number, "Figure Number *", class: "form-label fw-medium" %>
                <%= form.text_field :figure_number, 
                    class: "form-control #{'is-invalid' if @figure.errors[:figure_number].any?}",
                    required: true %>
                <% if @figure.errors[:figure_number].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:figure_number].first %>
                  </div>
                <% end %>
                <div class="form-text">Unique identifier for this figure</div>
              </div>
              
              <div class="col-md-8 mb-3">
                <%= form.label :name, "Figure Name *", class: "form-label fw-medium" %>
                <%= form.text_field :name, 
                    class: "form-control #{'is-invalid' if @figure.errors[:name].any?}",
                    required: true %>
                <% if @figure.errors[:name].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:name].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Classification -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-tags me-2"></i>Classification
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :dance_style_id, "Dance Style *", class: "form-label fw-medium" %>
                <%= form.select :dance_style_id, 
                    options_from_collection_for_select(@form_data[:dance_styles], :id, :name, @figure.dance_style_id),
                    { prompt: "Select Dance Style" },
                    { class: "form-select #{'is-invalid' if @figure.errors[:dance_style_id].any?}", required: true } %>
                <% if @figure.errors[:dance_style_id].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:dance_style_id].first %>
                  </div>
                <% end %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :dance_level_id, "Dance Level *", class: "form-label fw-medium" %>
                <%= form.select :dance_level_id, 
                    options_from_collection_for_select(@form_data[:dance_levels], :id, :name, @figure.dance_level_id),
                    { prompt: "Select Dance Level" },
                    { class: "form-select #{'is-invalid' if @figure.errors[:dance_level_id].any?}", required: true } %>
                <% if @figure.errors[:dance_level_id].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:dance_level_id].first %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Technical Details -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-cogs me-2"></i>Technical Details
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= form.label :measures, "Number of Measures *", class: "form-label fw-medium" %>
                <%= form.number_field :measures, 
                    class: "form-control #{'is-invalid' if @figure.errors[:measures].any?}",
                    required: true,
                    min: 0.1,
                    step: 0.1 %>
                <% if @figure.errors[:measures].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:measures].first %>
                  </div>
                <% end %>
                <div class="form-text">How many measures of music this figure takes</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Figure Type</label>
                <div class="form-check">
                  <%= form.check_box :is_core, class: "form-check-input" %>
                  <%= form.label :is_core, "Core Figure", class: "form-check-label" %>
                </div>
                <div class="form-text">Check if this is a core figure (required for level completion)</div>
              </div>
            </div>

            <!-- Components -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-list me-2"></i>Components & Description
                </h6>
              </div>
              
              <div class="col-12 mb-3">
                <%= form.label :components, "Components", class: "form-label fw-medium" %>
                <%= form.text_area :components, 
                    class: "form-control",
                    rows: 4 %>
                <div class="form-text">
                  Describe the individual components, steps, or elements that make up this figure
                </div>
              </div>
              
              <div class="col-12 mb-3" data-controller="youtube-preview">
                <%= form.label :video, "YouTube Video URL", class: "form-label fw-medium" %>
                <%= form.url_field :video, 
                    class: "form-control #{'is-invalid' if @figure.errors[:video].any?}",
                    placeholder: "https://www.youtube.com/watch?v=... or https://youtu.be/...",
                    data: { 
                      youtube_preview_target: "urlInput",
                      action: "input->youtube-preview#updatePreview"
                    } %>
                <% if @figure.errors[:video].any? %>
                  <div class="invalid-feedback">
                    <%= @figure.errors[:video].first %>
                  </div>
                <% end %>
                <div class="form-text">
                  <i class="fab fa-youtube me-1"></i>
                  Optional YouTube video demonstrating this figure. Supports youtube.com/watch, youtu.be, and youtube.com/embed URLs
                </div>
                <div data-youtube-preview-target="preview"></div>
              </div>
            </div>

            <!-- Current Status Display -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                  <i class="fas fa-info-circle me-2"></i>Current Status
                </h6>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-muted">Students Learning:</span>
                      <span class="fw-medium">
                        <% progress_count = @figure.student_progresses.count %>
                        <% if progress_count > 0 %>
                          <span class="badge bg-primary"><%= progress_count %> students</span>
                        <% else %>
                          <span class="text-muted">None</span>
                        <% end %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-muted">Created:</span>
                      <span class="fw-medium"><%= @figure.created_at.strftime("%B %d, %Y") %></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <div>
                    <%= link_to "Cancel", figure_path(@figure), class: "btn btn-outline-secondary" %>
                    <%= link_to "View Figure", figure_path(@figure), class: "btn btn-outline-info ms-2" %>
                  </div>
                  
                  <div>
                    <%= form.submit "Update Figure", 
                        class: "btn btn-primary",
                        data: { disable_with: "Updating Figure..." } %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card card-ballroom border-danger mt-4">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger mb-1">Delete Figure</h6>
              <p class="text-muted small mb-0">
                This action cannot be undone. All student progress for this figure will be lost.
                <% if @figure.student_progresses.any? %>
                  <strong class="text-warning">
                    Warning: <%= @figure.student_progresses.count %> students have progress on this figure.
                  </strong>
                <% end %>
              </p>
            </div>
            <div>
              <%= link_to figure_path(@figure), 
                  class: "btn btn-outline-danger",
                  data: { 
                    "turbo-method": :delete,
                    confirm: "Are you sure you want to delete '#{@figure.name}'? This action cannot be undone and will remove all student progress."
                  } do %>
                <i class="fas fa-trash me-1"></i>Delete Figure
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>

<style>
.card-ballroom {
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-label.fw-medium {
  font-weight: 500;
}

.border-bottom {
  border-color: #e9ecef !important;
}

.was-validated .form-control:valid {
  border-color: #198754;
}

.was-validated .form-control:invalid {
  border-color: #dc3545;
}
</style>
