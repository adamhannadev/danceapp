<%= content_for :title, params[:user_id].present? ? "#{@progress_data[:viewing_user].full_name}'s Progress" : "My Progress" %> 
<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-chart-line me-2 text-primary"></i>
            <% if params[:user_id].present? %>
              <%= @progress_data[:viewing_user].full_name %>'s Dance Progress
            <% else %>
              My Dance Progress
            <% end %>
          </h1>
          <p class="text-muted mb-0">
            <% if params[:user_id].present? %>
              Viewing progress for <%= @progress_data[:viewing_user].full_name %> (<%= @progress_data[:viewing_user].email %>)
            <% else %>
              Track your learning journey across all dance styles and levels
            <% end %>
          </p>
        </div>
        
        <!-- Navigation for Admin/Instructor -->
        <div class="text-end mt-4 mb-4">
          <% if current_user.admin? || current_user.instructor? %>
            <div class="btn-group me-3">
              <%= link_to all_students_student_progress_index_path, 
                          class: "btn btn-outline-secondary btn-sm" do %>
                <i class="fas fa-users me-1"></i>
                All Students
              <% end %>
              <% if params[:user_id].present? %>
                <%= link_to enroll_admin_user_student_progress_index_path(@progress_data[:viewing_user]), 
                            class: "btn btn-success btn-sm" do %>
                  <i class="fas fa-user-plus me-1"></i>
                  Enroll in Style/Level
                <% end %>
              <% end %>
              <% unless params[:user_id].present? %>
                <%= link_to student_progress_index_path_for(current_user), 
                            class: "btn btn-primary btn-sm" do %>
                  <i class="fas fa-user me-1"></i>
                  My Progress
                <% end %>
              <% else %>
                <%= link_to student_progress_index_path_for(current_user), 
                            class: "btn btn-outline-primary btn-sm" do %>
                  <i class="fas fa-arrow-left me-1"></i>
                  Back to My Progress
                <% end %>
              <% end %>
            </div>
          <% end %>
          
          <!-- Overall Progress Badge -->
          <!--<div class="card border-0 shadow-sm">
            <div class="card-body py-2 px-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-trophy text-warning fs-4"></i>
                </div>
                <div>
                  <div class="fw-bold text-primary fs-5"><%= @progress_data[:overall_completion] %>%</div>
                  <small class="text-muted">Overall Progress</small>
                </div>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card card-ballroom h-100">
        <div class="card-body text-center">
          <i class="fas fa-list-ol text-info fs-2 mb-2"></i>
          <h5 class="card-title"><%= @progress_data[:stats][:total_figures] %></h5>
          <p class="card-text text-muted">Total Figures</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-ballroom h-100">
        <div class="card-body text-center">
          <i class="fas fa-check-circle text-success fs-2 mb-2"></i>
          <h5 class="card-title"><%= @progress_data[:stats][:completed_figures] %></h5>
          <p class="card-text text-muted">Completed</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-ballroom h-100">
        <div class="card-body text-center">
          <i class="fas fa-clock text-warning fs-2 mb-2"></i>
          <h5 class="card-title"><%= @progress_data[:stats][:total_figures] - @progress_data[:stats][:completed_figures] %></h5>
          <p class="card-text text-muted">In Progress</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-ballroom h-100">
        <div class="card-body text-center">
          <i class="fas fa-percentage text-primary fs-2 mb-2"></i>
          <h5 class="card-title"><%= @progress_data[:stats][:overall_completion] %>%</h5>
          <p class="card-text text-muted">Completion Rate</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Dance Style Navigation -->
  <% if @progress_data[:available_dance_styles].any? %>
    <div class="row mb-3">
      <div class="col-12">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <span class="text-muted me-2">Quick Filter:</span>
          <%= link_to "All Styles", 
                      params[:user_id].present? ? admin_user_student_progress_index_path(@progress_data[:viewing_user]) : student_progress_index_path,
                      class: "btn #{'btn-primary' unless @progress_data[:selected_style]} #{'btn-outline-primary' if @progress_data[:selected_style]} btn-sm" %>
          <% @progress_data[:available_dance_styles].each do |style| %>
            <%= link_to style.name,
                        params[:user_id].present? ? 
                          admin_user_student_progress_index_path(@progress_data[:viewing_user], dance_style_id: style.id) :
                          student_progress_index_path(dance_style_id: style.id),
                        class: "btn #{'btn-primary' if @progress_data[:selected_style] == style} #{'btn-outline-primary' unless @progress_data[:selected_style] == style} btn-sm" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card card-ballroom">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-filter me-2"></i>Filter Progress
          </h6>
        </div>
        <div class="card-body">
          <%= form_with url: params[:user_id].present? ? admin_user_student_progress_index_path(@progress_data[:viewing_user]) : student_progress_index_path, 
                        method: :get, local: true, class: "row g-3" do |form| %>
            <% if params[:user_id].present? %>
              <%= form.hidden_field :user_id, value: params[:user_id] %>
            <% end %>
            <div class="col-md-4">
              <%= form.select :dance_style_id, 
                  options_from_collection_for_select(@progress_data[:available_dance_styles], :id, :name, @progress_data[:selected_style]&.id),
                  { prompt: "All Dance Styles" },
                  { class: "form-select" } %>
            </div>
            <div class="col-md-4">
              <%= form.select :dance_level_id,
                  options_from_collection_for_select(DanceLevel.ordered, :id, :name, @progress_data[:selected_level]&.id),
                  { prompt: "All Levels" },
                  { class: "form-select" } %>
            </div>
            <div class="col-md-4">
              <div class="d-flex gap-2">
                <%= form.submit "Apply Filters", class: "btn btn-primary" %>
                <%= link_to "Clear", params[:user_id].present? ? admin_user_student_progress_index_path(@progress_data[:viewing_user]) : student_progress_index_path, 
                            class: "btn btn-outline-secondary" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Table -->
  <% if @progress_data[:student_progresses_paginated].any? %>
    <div class="card card-ballroom mb-4">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Progress Overview
            <% if @progress_data[:selected_style] %>
              - <%= @progress_data[:selected_style].name %>
            <% end %>
            <% if @progress_data[:selected_level] %>
              - <%= @progress_data[:selected_level].name %>
            <% end %>
          </h5>
          <div>
            <span class="badge bg-primary"><%= @progress_data[:stats][:total_figures] %> Total</span>
            <span class="badge bg-success"><%= @progress_data[:stats][:completed_figures] %> Completed</span>
            <span class="badge bg-warning"><%= @progress_data[:stats][:total_figures] - @progress_data[:stats][:completed_figures] %> In Progress</span>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Figure</th>
                <th>Style & Level</th>
                <th>Type</th>
                <th class="text-center">Movement</th>
                <th class="text-center">Timing</th>
                <th class="text-center">Partnering</th>
                <th class="text-center">Progress</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @progress_data[:progresses_by_style].each do |dance_style, progresses| %>
                <% progresses.group_by { |sp| sp.figure.dance_level }.each do |level, level_progresses| %>
                  <% group_by_core_figures(level_progresses).each do |core_number, group| %>
                    <!-- Core Figure -->
                    <% if group[:core] %>
                      <% progress = group[:core] %>
                      <tr class="<%= 'table-success' if progress.completed? %> core-figure-row">
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2"><%= progress.figure.figure_number %></span>
                            <div>
                              <strong><%= progress.figure.name %></strong>
                              <% if progress.figure.components.present? %>
                                <br><small class="text-muted"><%= truncate(progress.figure.components, length: 60) %></small>
                              <% end %>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span class="badge bg-secondary"><%= dance_style.name %></span>
                            <br><span class="badge <%= dance_level_badge_class(level) %> mt-1"><%= level.name %></span>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-success"><i class="fas fa-star me-1"></i>Core</span>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.movement_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="movement"
                                    data-passed="<%= progress.movement_passed? %>">
                              <i class="fas fa-<%= progress.movement_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.movement_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.movement_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.timing_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="timing"
                                    data-passed="<%= progress.timing_passed? %>">
                              <i class="fas fa-<%= progress.timing_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.timing_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.timing_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.partnering_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="partnering"
                                    data-passed="<%= progress.partnering_passed? %>">
                              <i class="fas fa-<%= progress.partnering_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.partnering_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.partnering_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <div class="progress" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-success" style="width: <%= progress.completion_percentage %>%"></div>
                          </div>
                          <small class="text-muted"><%= progress.completion_percentage %>%</small>
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <% show_url = (current_user.admin? || current_user.instructor?) && current_user != @progress_data[:viewing_user] ? 
                                admin_user_student_progress_path(@progress_data[:viewing_user], progress) : 
                                student_progress_path(progress) %>
                            <%= link_to show_url, class: "btn btn-outline-primary btn-sm", title: "View Details" do %>
                              <i class="fas fa-eye"></i>
                            <% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                    
                    <!-- Variations -->
                    <% group[:variations].each do |progress| %>
                      <tr class="<%= 'table-success' if progress.completed? %> variation-row">
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="badge bg-info me-2"><%= progress.figure.figure_number %></span>
                            <div>
                              <strong><%= progress.figure.name %></strong>
                              <% if progress.figure.components.present? %>
                                <br><small class="text-muted"><%= truncate(progress.figure.components, length: 60) %></small>
                              <% end %>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div>
                            <span class="badge bg-secondary"><%= dance_style.name %></span>
                            <br><span class="badge <%= dance_level_badge_class(level) %> mt-1"><%= level.name %></span>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-info"><i class="fas fa-plus me-1"></i>Variation</span>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.movement_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="movement"
                                    data-passed="<%= progress.movement_passed? %>">
                              <i class="fas fa-<%= progress.movement_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.movement_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.movement_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.timing_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="timing"
                                    data-passed="<%= progress.timing_passed? %>">
                              <i class="fas fa-<%= progress.timing_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.timing_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.timing_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <% if current_user.admin? || current_user.instructor? %>
                            <button class="btn btn-sm component-toggle <%= progress.partnering_passed? ? 'btn-success' : 'btn-outline-secondary' %>"
                                    data-progress-id="<%= progress.id %>"
                                    data-component="partnering"
                                    data-passed="<%= progress.partnering_passed? %>">
                              <i class="fas fa-<%= progress.partnering_passed? ? 'check' : 'times' %>"></i>
                            </button>
                          <% else %>
                            <span class="badge <%= progress.partnering_passed? ? 'bg-success' : 'bg-secondary' %>">
                              <i class="fas fa-<%= progress.partnering_passed? ? 'check' : 'clock' %>"></i>
                            </span>
                          <% end %>
                        </td>
                        <td class="text-center">
                          <div class="progress" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-success" style="width: <%= progress.completion_percentage %>%"></div>
                          </div>
                          <small class="text-muted"><%= progress.completion_percentage %>%</small>
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <% show_url = (current_user.admin? || current_user.instructor?) && current_user != @progress_data[:viewing_user] ? 
                                admin_user_student_progress_path(@progress_data[:viewing_user], progress) : 
                                student_progress_path(progress) %>
                            <%= link_to show_url, class: "btn btn-outline-primary btn-sm", title: "View Details" do %>
                              <i class="fas fa-eye"></i>
                            <% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Pagination -->
      <% if @progress_data[:student_progresses_paginated].respond_to?(:total_pages) && @progress_data[:student_progresses_paginated].total_pages > 1 %>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
              Showing <%= (@progress_data[:student_progresses_paginated].current_page - 1) * @progress_data[:student_progresses_paginated].limit_value + 1 %>
              to <%= [@progress_data[:student_progresses_paginated].current_page * @progress_data[:student_progresses_paginated].limit_value, @progress_data[:stats][:total_figures]].min %>
              of <%= @progress_data[:stats][:total_figures] %> figures
            </div>
            <div>
              <%= paginate @progress_data[:student_progresses_paginated], 
                          params: { dance_style_id: params[:dance_style_id], dance_level_id: params[:dance_level_id], user_id: params[:user_id] },
                          theme: 'bootstrap4' %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="card card-ballroom ">
      <div class="card-body text-center py-5">
        <i class="fas fa-music fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Progress Found</h5>
        <p class="text-muted mb-4">
          <% if params[:user_id].present? %>
            <%= @progress_data[:viewing_user].full_name %> hasn't been enrolled in any dance figures yet.
          <% else %>
            You haven't been enrolled in any dance figures yet.
          <% end %>
        </p>
        <% if current_user.admin? || current_user.instructor? %>
          <% if params[:user_id].present? %>
            <%= link_to enroll_admin_user_student_progress_index_path(@progress_data[:viewing_user]), 
                        class: "btn btn-primary" do %>
              <i class="fas fa-user-plus me-2"></i>Enroll Student
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<style>
.card-ballroom {
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.core-figure-row {
  background-color: #f8f9ff;
  border-left: 3px solid #0d6efd;
}

.variation-row {
  background-color: #f8f9fa;
  border-left: 3px solid #6c757d;
}

.component-toggle {
  min-width: 35px;
  transition: all 0.2s ease;
}

.component-toggle:hover {
  transform: scale(1.1);
}

.table-hover tbody tr:hover {
  background-color: rgba(0,0,0,.075);
}

.table th {
  font-weight: 600;
  border-bottom: 2px solid #dee2e6;
}

.progress {
  border-radius: 10px;
}

.progress-bar {
  border-radius: 10px;
}

/* Dance Level Badge Colors */
.dance-level-bronze-1 {
  background-color: #cd7f32 !important;
  color: white !important;
}

.dance-level-bronze-2 {
  background-color: #b8722c !important;
  color: white !important;
}

.dance-level-bronze-3 {
  background-color: #a36427 !important;
  color: white !important;
}

.dance-level-bronze-4 {
  background-color: #8e5621 !important;
  color: white !important;
}

.dance-level-silver-1 {
  background-color: #c0c0c0 !important;
  color: #333 !important;
}

.dance-level-silver-2 {
  background-color: #b8b8b8 !important;
  color: #333 !important;
}

.dance-level-silver-3 {
  background-color: #a8a8a8 !important;
  color: white !important;
}

.dance-level-silver-4 {
  background-color: #909090 !important;
  color: white !important;
}

.dance-level-gold-1 {
  background-color: #ffd700 !important;
  color: #333 !important;
}

.dance-level-gold-2 {
  background-color: #ffcc00 !important;
  color: #333 !important;
}

.dance-level-gold-3 {
  background-color: #e6b800 !important;
  color: white !important;
}

.dance-level-gold-4 {
  background-color: #cc9900 !important;
  color: white !important;
}
</style>

<script>
function setupComponentToggleButtons() {
  // Handle component toggle buttons
  document.querySelectorAll('.component-toggle').forEach(button => {
    // Remove any existing listeners to avoid duplicates
    button.removeEventListener('click', handleComponentToggle);
    // Add the event listener
    button.addEventListener('click', handleComponentToggle);
  });
}

function handleComponentToggle() {
  const progressId = this.dataset.progressId;
  const component = this.dataset.component;
  const currentlyPassed = this.dataset.passed === 'true';
  
  console.log('Button clicked:', { progressId, component, currentlyPassed });
  
  // Show loading state
  const originalContent = this.innerHTML;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  this.disabled = true;
  
  // Build the URL based on whether we're viewing a specific user or current user
  let baseUrl = '<%= (current_user.admin? || current_user.instructor?) && current_user != @progress_data[:viewing_user] ? "/admin/manage_users/#{@progress_data[:viewing_user].id}/student_progress" : "/student_progress" %>';
  let url = `${baseUrl}/${progressId}/mark_progress`;
  
  console.log('Making request to:', url);
      
  // Make the AJAX request
  fetch(url, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
      'Accept': 'application/json'
    },
    body: JSON.stringify({ component: component })
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      // Update button state
      const newPassed = !currentlyPassed;
      this.dataset.passed = newPassed;
      
      if (newPassed) {
        this.className = 'btn btn-sm component-toggle btn-success';
        this.innerHTML = '<i class="fas fa-check"></i>';
      } else {
        this.className = 'btn btn-sm component-toggle btn-outline-secondary';
        this.innerHTML = '<i class="fas fa-times"></i>';
      }
      
      // Re-enable the button
      this.disabled = false;
      
      // Update the row background if completed
      const row = this.closest('tr');
      if (data.completed) {
        row.classList.add('table-success');
        // Flash success message
        if (typeof showToast === 'function') {
          showToast('Figure completed! 🎉', 'success');
        }
      } else {
        row.classList.remove('table-success');
      }
      
      // Update progress bar
      const progressBar = row.querySelector('.progress-bar');
      const progressText = row.querySelector('.progress + small');
      if (progressBar && progressText) {
        progressBar.style.width = data.completion_percentage + '%';
        progressText.textContent = data.completion_percentage + '%';
      }
    } else {
      throw new Error(data.error || 'Failed to update progress');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    this.innerHTML = originalContent;
    this.disabled = false;
    // Use alert as fallback if showToast doesn't exist
    if (typeof showToast === 'function') {
      showToast('Failed to update progress. Please try again.', 'error');
    } else {
      alert('Failed to update progress. Please try again.');
    }
  });
}

// Set up event listeners on page load and Turbo navigation
document.addEventListener('DOMContentLoaded', setupComponentToggleButtons);
document.addEventListener('turbo:load', setupComponentToggleButtons);
document.addEventListener('turbo:frame-load', setupComponentToggleButtons);

// Toast notification function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed top-0 end-0 m-3`;
  toast.style.zIndex = '9999';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  document.body.appendChild(toast);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, 3000);
}
</script>
