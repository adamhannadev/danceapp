<% content_for :title, @user.full_name %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Dashboard", dashboard_path %></li>
          <li class="breadcrumb-item"><%= link_to "Users", users_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @user.full_name %></li>
        </ol>
      </nav>
      
      <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center">
          <div class="bg-<%= user_role_color(@user.role) %> rounded-circle d-flex align-items-center justify-content-center me-4" 
               style="width: 80px; height: 80px;">
            <i class="fas fa-<%= user_role_icon(@user.role) %> text-white fs-1"></i>
          </div>
          <div>
            <h1 class="h3 mb-1"><%= @user.full_name %></h1>
            <p class="text-muted mb-2"><%= @user.email %></p>
            <div class="d-flex gap-2">
              <span class="badge bg-<%= user_role_color(@user.role) %> fs-6">
                <%= @user.role.titleize %>
              </span>
              <% if @user.has_membership? %>
                <span class="badge bg-success fs-6">
                  <%= @user.membership_type.titleize %> Member
                </span>
              <% end %>
              <% if @user.waiver_signed? %>
                <span class="badge bg-success fs-6">
                  <i class="fas fa-check me-1"></i>Waiver Signed
                </span>
              <% else %>
                <span class="badge bg-warning fs-6">
                  <i class="fas fa-exclamation-triangle me-1"></i>Waiver Pending
                </span>
              <% end %>
            </div>
          </div>
        </div>
        
        <div class="text-end">
          <%= link_to edit_user_path(@user), class: "btn btn-primary" do %>
            <i class="fas fa-edit me-2"></i>Edit Profile
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Profile Information -->
    <div class="col-lg-4">
      <!-- Contact Information -->
      <div class="card card-ballroom mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-address-card me-2"></i>Contact Information
          </h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Email:</dt>
            <dd class="col-sm-8">
              <a href="mailto:<%= @user.email %>" class="text-decoration-none">
                <%= @user.email %>
              </a>
            </dd>
            
            <% if @user.phone.present? %>
              <dt class="col-sm-4">Phone:</dt>
              <dd class="col-sm-8">
                <a href="tel:<%= @user.phone %>" class="text-decoration-none">
                  <%= @user.phone %>
                </a>
              </dd>
            <% end %>
            
            <dt class="col-sm-4">Role:</dt>
            <dd class="col-sm-8">
              <span class="badge bg-<%= user_role_color(@user.role) %>">
                <%= @user.role.titleize %>
              </span>
            </dd>
            
            <dt class="col-sm-4">Joined:</dt>
            <dd class="col-sm-8">
              <%= @user.created_at.strftime("%B %d, %Y") %>
            </dd>
          </dl>
        </div>
      </div>

      <!-- Membership Information -->
      <div class="card card-ballroom mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-crown me-2"></i>Membership
          </h5>
        </div>
        <div class="card-body">
          <% if @user.has_membership? %>
            <div class="text-center">
              <i class="fas fa-crown text-warning fs-2 mb-3"></i>
              <h6 class="mb-2"><%= @user.membership_type.titleize %> Membership</h6>
              <% if @user.membership_discount > 0 %>
                <p class="text-success mb-0">
                  <i class="fas fa-percentage me-1"></i>
                  <%= @user.membership_discount %>% Discount
                </p>
              <% end %>
            </div>
          <% else %>
            <div class="text-center">
              <i class="fas fa-user text-muted fs-2 mb-3"></i>
              <h6 class="text-muted mb-2">No Membership</h6>
              <p class="text-muted small mb-0">Consider upgrading to a membership for benefits and discounts.</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Waiver Status -->
      <div class="card card-ballroom">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-file-signature me-2"></i>Waiver Status
          </h5>
        </div>
        <div class="card-body">
          <% if @user.waiver_signed? %>
            <div class="text-center">
              <i class="fas fa-check-circle text-success fs-2 mb-3"></i>
              <h6 class="text-success mb-2">Waiver Signed</h6>
              <% if @user.waiver_signed_at %>
                <p class="text-muted small mb-0">
                  Signed on <%= @user.waiver_signed_at.strftime("%B %d, %Y") %>
                </p>
              <% end %>
            </div>
          <% else %>
            <div class="text-center">
              <i class="fas fa-exclamation-triangle text-warning fs-2 mb-3"></i>
              <h6 class="text-warning mb-2">Waiver Pending</h6>
              <p class="text-muted small mb-3">Waiver must be signed before participating in classes.</p>
              <button class="btn btn-warning btn-sm" onclick="alert('Waiver signing functionality would be implemented here')">
                <i class="fas fa-pen me-1"></i>Sign Waiver
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Right Column: Activity & Details -->
    <div class="col-lg-8">
      <% if @user.student? %>
        <!-- Student Progress Section -->
        <div class="card card-ballroom mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Learning Progress
              </h5>
              <%= link_to student_progress_index_path, class: "btn btn-sm btn-outline-primary" do %>
                <i class="fas fa-eye me-1"></i>View All Progress
              <% end %>
            </div>
          </div>
          <div class="card-body">
            <% if @recent_progress.any? %>
              <div class="row">
                <% @recent_progress.each do |progress| %>
                  <div class="col-md-6 mb-3">
                    <div class="border rounded p-3">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0"><%= progress.figure.name %></h6>
                        <span class="badge bg-<%= progress.completed? ? 'success' : 'warning' %>">
                          <%= progress.completion_percentage %>%
                        </span>
                      </div>
                      <p class="text-muted small mb-2">
                        <%= progress.figure.dance_style.name %> • <%= progress.figure.dance_level.name %>
                      </p>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: <%= progress.completion_percentage %>%"></div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-graduation-cap text-muted fs-2 mb-3"></i>
                <h6 class="text-muted">No Progress Yet</h6>
                <p class="text-muted small">Start learning some figures to see progress here.</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Upcoming Bookings -->
        <div class="card card-ballroom mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calendar-alt me-2"></i>Upcoming Classes
            </h5>
          </div>
          <div class="card-body">
            <% if @upcoming_bookings.any? %>
              <div class="list-group list-group-flush">
                <% @upcoming_bookings.each do |booking| %>
                  <div class="list-group-item border-0 px-0">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="mb-1"><%= booking.class_schedule.dance_class.name %></h6>
                        <p class="mb-1 text-muted">
                          <%= booking.class_schedule.dance_class.dance_style.name %> • 
                          <%= booking.class_schedule.dance_class.dance_level.name %>
                        </p>
                        <small class="text-muted">
                          <i class="fas fa-clock me-1"></i>
                          <%= booking.class_schedule.start_datetime.strftime("%B %d, %Y at %I:%M %p") %>
                        </small>
                      </div>
                      <span class="badge bg-<%= booking_status_color(booking.status) %>">
                        <%= booking.status.titleize %>
                      </span>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-calendar-plus text-muted fs-2 mb-3"></i>
                <h6 class="text-muted">No Upcoming Classes</h6>
                <p class="text-muted small">Book some classes to see them here.</p>
                <%= link_to dance_classes_path, class: "btn btn-primary btn-sm" do %>
                  <i class="fas fa-plus me-1"></i>Browse Classes
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

      <% elsif @user.instructor? %>
        <!-- Instructor Classes -->
        <div class="card card-ballroom mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chalkboard-teacher me-2"></i>Teaching Classes
            </h5>
          </div>
          <div class="card-body">
            <% if @teaching_classes.any? %>
              <div class="row">
                <% @teaching_classes.each do |dance_class| %>
                  <div class="col-md-6 mb-3">
                    <div class="border rounded p-3">
                      <h6 class="mb-2"><%= dance_class.name %></h6>
                      <p class="text-muted small mb-2">
                        <%= dance_class.dance_style.name %> • <%= dance_class.dance_level.name %>
                      </p>
                      <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                          <i class="fas fa-users me-1"></i>
                          Max <%= dance_class.max_capacity %> students
                        </small>
                        <small class="text-muted">
                          $<%= dance_class.price %> per class
                        </small>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-chalkboard text-muted fs-2 mb-3"></i>
                <h6 class="text-muted">No Classes Assigned</h6>
                <p class="text-muted small">Classes will appear here when assigned.</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Instructor Availability -->
        <% if current_user&.admin? || current_user == @user %>
          <div class="card card-ballroom mb-4">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="fas fa-calendar-check me-2"></i>Availability Schedule
                </h5>
                <%= link_to user_availabilities_path(@user), class: "btn btn-sm btn-outline-primary" do %>
                  <i class="fas fa-calendar-alt me-1"></i>Manage Calendar
                <% end %>
              </div>
            </div>
            <div class="card-body">
              <% instructor_availabilities = @user.instructor_availabilities.includes(:location) %>
              <% if instructor_availabilities.any? %>
                <!-- Availability Summary -->
                <!-- <div class="row mb-3">
                  <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                      <i class="fas fa-clock text-primary fs-4 mb-2"></i>
                      <h6 class="mb-0"><%= instructor_availabilities.count %></h6>
                      <small class="text-muted">Total Slots</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                      <i class="fas fa-calendar-week text-success fs-4 mb-2"></i>
                      <h6 class="mb-0">
                        <%= instructor_availabilities.where('start_time >= ?', Time.current.beginning_of_week).count %>
                      </h6>
                      <small class="text-muted">This Week</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                      <i class="fas fa-map-marker-alt text-info fs-4 mb-2"></i>
                      <h6 class="mb-0">
                        <%= instructor_availabilities.joins(:location).select(:location_id).distinct.count %>
                      </h6>
                      <small class="text-muted">Locations</small>
                    </div>
                  </div>
                </div> -->

                <!-- Recent Availability Slots -->
                <h6 class="mb-3">Upcoming Availability</h6>
                <div class="row">
                  <% instructor_availabilities.where('start_time >= ?', Time.current).order(:start_time).limit(6).each do |availability| %>
                    <div class="col-md-6 mb-3">
                      <div class="border rounded p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <h6 class="mb-0">
                            <%= availability.start_time.strftime("%A, %b %d") %>
                          </h6>
                          <span class="badge bg-success">Available</span>
                        </div>
                        <p class="text-muted small mb-2">
                          <i class="fas fa-clock me-1"></i>
                          <%= availability.start_time.strftime("%I:%M %p") %> - 
                          <%= availability.end_time.strftime("%I:%M %p") %>
                        </p>
                        <% if availability.location %>
                          <p class="text-muted small mb-0">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <%= availability.location.name %>
                          </p>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>

                <% if instructor_availabilities.where('start_time >= ?', Time.current).count > 6 %>
                  <div class="text-center mt-3">
                    <%= link_to user_availabilities_path(@user), class: "btn btn-outline-primary btn-sm" do %>
                      <i class="fas fa-calendar me-1"></i>View All Availability
                    <% end %>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-4">
                  <i class="fas fa-calendar-plus text-muted fs-2 mb-3"></i>
                  <h6 class="text-muted">No Availability Set</h6>
                  <p class="text-muted small mb-3">Set your availability schedule to let students know when you're free for lessons.</p>
                  <%= link_to user_availabilities_path(@user), class: "btn btn-primary btn-sm" do %>
                    <i class="fas fa-plus me-1"></i>Set Availability
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Activity Log -->
      <div class="card card-ballroom">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>Recent Activity
          </h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-marker bg-info"></div>
              <div class="timeline-content">
                <h6>Profile Created</h6>
                <small class="text-muted">
                  <%= @user.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                </small>
              </div>
            </div>
            
            <% if @user.waiver_signed_at %>
              <div class="timeline-item">
                <div class="timeline-marker bg-success"></div>
                <div class="timeline-content">
                  <h6>Waiver Signed</h6>
                  <small class="text-muted">
                    <%= @user.waiver_signed_at.strftime("%B %d, %Y at %I:%M %p") %>
                  </small>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card-ballroom {
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline-item {
  position: relative;
  margin-bottom: 20px;
}

.timeline-marker {
  position: absolute;
  left: -22px;
  top: 2px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 3px solid white;
}

.timeline::before {
  content: '';
  position: absolute;
  left: -16px;
  top: 8px;
  bottom: 0;
  width: 2px;
  background: #e9ecef;
}

.timeline-content h6 {
  margin-bottom: 5px;
  font-size: 0.9rem;
}

.progress {
  border-radius: 10px;
}

.progress-bar {
  border-radius: 10px;
}
</style>
